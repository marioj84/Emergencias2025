<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz Emergencias 2025</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa6b2;
    --accent:#06b6d4; --success:#1a7f37; --danger:#9b1e2a;
    font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body { background: linear-gradient(180deg,#071025 0%, #07182a 100%); color:#e6eef6; margin:0; padding:20px; min-height:100vh; display:flex; justify-content:center; align-items:flex-start; }
  .wrap { width:100%; max-width:820px; }
  header { display:flex; gap:12px; align-items:center; margin-bottom:18px; }
  header h1 { margin:0; font-size:20px; letter-spacing:0.2px; }
  .controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
  .card { background:var(--card); padding:22px; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,0.6); }
  .meta { display:flex; gap:12px; align-items:center; color:var(--muted); margin-bottom:14px; }
  .question { font-size:18px; margin:10px 0 18px; }
  .options { display:flex; flex-direction:column; gap:10px; }
  .option { text-align:left; padding:12px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); cursor:pointer; transition:all .15s; }
  .option:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,0.5); }
  .option.disabled { pointer-events:none; opacity:0.9; transform:none; }
  .option.correct { background:rgba(26,127,55,0.12); border-color:rgba(26,127,55,0.6); color:var(--success); font-weight:600; }
  .option.incorrect { background:rgba(155,30,42,0.12); border-color:rgba(155,30,42,0.5); color:var(--danger); font-weight:600; }
  .buttons { display:flex; gap:8px; margin-top:16px; }
  button { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; background:var(--accent); color:#042026; font-weight:700; }
  button.ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }
  .progress-wrap { margin-top:18px; }
  .progress { height:12px; background:rgba(255,255,255,0.04); border-radius:999px; overflow:hidden; }
  .progress > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent), #6ee7b7); transition:width .35s; }
  .small { font-size:13px; color:var(--muted); }
  .file-input { display:flex; gap:8px; align-items:center; }
  input[type=file] { color:var(--muted); }
  .score { margin-left:12px; font-weight:700; color:#dbeafe; }
  footer.note { margin-top:10px; color:var(--muted); font-size:13px; }
  @media (max-width:600px){
    .meta { flex-direction:column; align-items:flex-start; gap:6px; }
    header { gap:8px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Quiz — Emergencias 2025</h1>
      <div class="controls">
        <div class="file-input">
          <label class="small" for="file">Cargar archivo (.json/.csv):</label>
          <input id="file" type="file" accept=".json,.csv" />
        </div>
        <button id="loadSample" class="ghost">Cargar ejemplo</button>
        <div class="score small" id="score">Aciertos: 0 / 0</div>
      </div>
    </header>

    <div class="card" id="card">
      <div class="meta">
        <div class="small" id="qIndex">Pregunta 0 / 0</div>
        <div class="small" id="qType">—</div>
      </div>

      <div class="question" id="question">Cargue preguntas para empezar</div>

      <div class="options" id="options"></div>

      <div class="buttons">
        <button id="nextBtn" disabled>Siguiente ►</button>
        <button id="restartBtn" class="ghost">Reiniciar</button>
      </div>

      <div class="progress-wrap">
        <div class="small" id="progressText">Progreso: 0%</div>
        <div class="progress" aria-hidden="true"><i id="progressBar"></i></div>
      </div>

      <footer class="note">
        Por defecto si la pregunta no tiene `correctIndex`, se considera correcta la primera opción (índice 0). Puedes añadir `correctIndex` en el JSON más tarde.
      </footer>
    </div>
  </div>

<script>
let questions = [];
let current = 0;
let score = 0;
const qIndexEl = document.getElementById('qIndex');
const qTypeEl = document.getElementById('qType');
const questionEl = document.getElementById('question');
const optionsEl = document.getElementById('options');
const nextBtn = document.getElementById('nextBtn');
const restartBtn = document.getElementById('restartBtn');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const scoreEl = document.getElementById('score');
const fileInput = document.getElementById('file');
const loadSample = document.getElementById('loadSample');

function render() {
  const total = questions.length;
  if (total === 0) {
    questionEl.textContent = 'Cargue preguntas (JSON o CSV) o pulsa "Cargar ejemplo".';
    qIndexEl.textContent = 'Pregunta 0 / 0';
    optionsEl.innerHTML = '';
    progressBar.style.width = '0%';
    progressText.textContent = 'Progreso: 0%';
    scoreEl.textContent = `Aciertos: 0 / 0`;
    return;
  }
  const q = questions[current];
  qIndexEl.textContent = `Pregunta ${current + 1} / ${total}`;
  qTypeEl.textContent = q.meta ? q.meta : '';
  questionEl.textContent = q.question || 'Pregunta sin texto';
  optionsEl.innerHTML = '';
  (q.options || []).forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'option';
    btn.type = 'button';
    btn.innerHTML = `<span>${String.fromCharCode(65+i)}.</span> ${opt}`;
    btn.dataset.idx = i;
    btn.addEventListener('click', () => handleAnswer(i));
    optionsEl.appendChild(btn);
  });
  const pct = Math.round(((current) / total) * 100);
  progressBar.style.width = pct + '%';
  progressText.textContent = `Progreso: ${pct}%`;
  scoreEl.textContent = `Aciertos: ${score} / ${total}`;
  nextBtn.disabled = true;
}

function handleAnswer(selectedIndex) {
  const q = questions[current];
  const correctIndex = (typeof q.correctIndex === 'number') ? q.correctIndex : 0;
  const btns = Array.from(optionsEl.children);
  btns.forEach(b => b.classList.add('disabled'));
  const correctBtn = btns[correctIndex];
  if (correctBtn) correctBtn.classList.add('correct');
  if (selectedIndex !== correctIndex) {
    const selBtn = btns[selectedIndex];
    if (selBtn) selBtn.classList.add('incorrect');
  } else {
    score += 1;
  }
  const total = questions.length;
  scoreEl.textContent = `Aciertos: ${score} / ${total}`;
  nextBtn.disabled = false;
}

nextBtn.addEventListener('click', () => {
  current++;
  if (current >= questions.length) {
    progressBar.style.width = '100%';
    progressText.textContent = `Progreso: 100% — Finalizado`;
    questionEl.textContent = `Fin del quiz. Acertaste ${score} de ${questions.length}.`;
    optionsEl.innerHTML = '';
    qIndexEl.textContent = `Resultado`;
    nextBtn.disabled = true;
    return;
  }
  render();
});

restartBtn.addEventListener('click', () => {
  current = 0; score = 0;
  render();
});

function loadFromJsonArray(arr) {
  questions = arr.map(item => {
    const opts = item.options || item.answers || [];
    return {
      question: item.question || item.pregunta || ('Pregunta ' + (Math.random().toString(36).slice(2,6))),
      options: opts,
      correctIndex: typeof item.correctIndex === 'number' ? item.correctIndex :
                    (typeof item.correct === 'number' ? item.correct : undefined),
      meta: item.meta || ''
    };
  });
  current = 0; score = 0;
  render();
}

function parseCSV(text) {
  const rows = [];
  const re = /(?:,|\n|^)(?:"([^"]*(?:""[^"]*)*)"|([^",\n]*))/g;
  let match;
  let row = [];
  re.lastIndex = 0;
  while ((match = re.exec(text)) !== null) {
    const val = match[1] !== undefined ? match[1].replace(/""/g, '"') : match[2];
    row.push(val === undefined ? '' : val);
    const c = text[re.lastIndex - 1];
    if (c === '\n' || re.lastIndex === text.length) {
      rows.push(row);
      row = [];
    }
    if (re.lastIndex >= text.length) break;
  }
  if (rows.length === 0) {
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    lines.forEach(l => rows.push(l.split(',').map(s=>s.trim())));
  }
  return rows;
}

function csvToQuestions(csvText) {
  const rows = parseCSV(csvText).filter(r => r.length && r.some(c => c !== ''));
  if (rows.length === 0) return [];
  const header = rows[0].map(c => c.toLowerCase());
  const hasHeader = header.some(h => /question|pregunta|option|opci|option1/.test(h));
  const dataRows = hasHeader ? rows.slice(1) : rows;
  const result = dataRows.map(r => {
    const q = r[0] || '';
    const options = r.slice(1,5).filter(x => x !== undefined && x !== '');
    let correctIndex;
    if (r[5] !== undefined && r[5] !== '') {
      const v = r[5].trim();
      if (!isNaN(Number(v))) correctIndex = Number(v);
      else if (/^[A-Da-d]$/.test(v)) correctIndex = v.toUpperCase().charCodeAt(0) - 65;
    }
    return { question: q, options, correctIndex };
  });
  return result;
}

fileInput.addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const txt = reader.result;
    if (f.name.toLowerCase().endsWith('.json')) {
      try {
        const arr = JSON.parse(txt);
        if (!Array.isArray(arr)) throw new Error('JSON debe ser un array');
        loadFromJsonArray(arr);
      } catch (err) {
        alert('Error parseando JSON: ' + err.message);
      }
    } else if (f.name.toLowerCase().endsWith('.csv')) {
      try {
        const arr = csvToQuestions(txt);
        if (!arr || arr.length === 0) throw new Error('CSV vacío o mal formado');
        loadFromJsonArray(arr);
      } catch (err) {
        alert('Error parseando CSV: ' + err.message);
      }
    } else {
      alert('Formato no soportado. Usa .json o .csv');
    }
  };
  reader.readAsText(f, 'utf-8');
});

loadSample.addEventListener('click', () => {
  const sample = [
    { question: "¿Qué hacer primero ante una fuga de gas?", options: ["Cerrar la llave de paso", "Llamar sin moverse", "Encender un ventilador", "Buscar el medidor"], correctIndex: 0 },
    { question: "Síntoma típico de una fuga en ambiente cerrado:", options: ["Olor a huevos podridos", "Luz intermitente", "Aumento de presión eléctrica", "Vibración en tubería"], correctIndex: 0 },
    { question: "¿Qué NO debes hacer cerca de una fuga?", options: ["Encender fuego o chispa", "Ventilar el lugar", "Abrir puertas", "Evacuar a personas"], correctIndex: 0 }
  ];
  loadFromJsonArray(sample);
});

fetch('questions.json').then(r => {
  if (!r.ok) throw new Error('no file');
  return r.json();
}).then(arr => {
  if (Array.isArray(arr) && arr.length) loadFromJsonArray(arr);
}).catch(()=> {
  render();
});

render();
</script>
</body>
</html>
